
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>
            LiTScript - Bundler
        </title>
        <link rel="icon" type="image/icon" href="../images/favicon.png" />
        <link rel="stylesheet" href="../css/normal.css" />
        
    </head>
    <body>
        
        <div id="navbar">
            <div class="navmenu">
                
    <a class="title enabled" href="../index.html">
        <img src="../images/bulb.svg" />
        <span>LiTScript</span>
    </a>
    <a class="enabled" href="https://www.npmjs.com/package/litscript">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-npm" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M1 8h22v7h-12v2h-4v-2h-6z" />
            <path d="M7 8v7" />
            <path d="M14 8v7" />
            <path d="M17 11v4" />
            <path d="M4 11v4" />
            <path d="M11 11v1" />
            <path d="M20 11v4" />
        </svg>
        <span>Download</span>
    </a>
    <a class="enabled" href="https://github.com/johtela/litscript">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
        </svg>
        <span>GitHub</span>
    </a>
    <a class="enabled" href="../license.html">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-license" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M15 21h-9a3 3 0 0 1 -3 -3v-1h10v2a2 2 0 0 0 4 0v-14a2 2 0 1 1 2 2h-2m2 -4h-11a3 3 0 0 0 -3 3v11" />
            <path d="M9 7l4 0" />
            <path d="M9 11l4 0" />
        </svg>
        <span>License</span>
    </a>
            </div>
            
    <a class="hamburger">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
    </a>
        </div>
        
        <div class="layout">
            <div class="sidepane narrow-scrollbars">
                
        <div class="tocmenu">
            <h3>Table of Contents</h3>
            
    <ul>
        
    <li>
        
        <a href="../index.html"><span>🏠</span><span data-toggle="tooltip" data-title="Home page">
            Home
        </span></a>
        
    </li>
    <li>
        
        <a href="../introduction.html"><span>🤝</span><span data-toggle="tooltip" data-title="Introduction and Motivation">
            Introduction
        </span></a>
        
    </li>
    <li>
        
        <a href="config.html"><span>🎛️</span><span data-toggle="tooltip" data-title="Configuration options and command line parsing">
            Configuration
        </span></a>
        
    </li>
    <li>
        
        <a href="templates/toc.html"><span>📖</span>Table of Contents</a>
        
    </li>
    <li>
        
        <a href="templates/front-matter.html"><span>📋</span>Front Matter</a>
        
    </li>
    <li>
        
        <a href="region.html"><span>🌍</span><span data-toggle="tooltip" data-title="Embedding Regions of Code in Markdown">
            Regions
        </span></a>
        
    </li>
    <li>
        
        <a href="visualizer.html"><span>🕶️</span><span data-toggle="tooltip" data-title="Adding dynamic content to HTML pages">
            Visualizers
        </span></a>
        
    </li>
    <li>
        
        <a href="dependency-graph.html"><span>🕸️</span><span data-toggle="tooltip" data-title="Creating module dependency graph">
            Dependency Graph
        </span></a>
        
    </li>
    <li>
        
        <a href="bundler.html" class="highlight"><span>📦</span><span data-toggle="tooltip" data-title="Packing JS & CSS files">
            Bundler
        </span></a>
        
    </li>
    <li>
        <div class="accordion">
        Site Templates
        </div>
            
    <ul>
        
    <li>
        
        <a href="templates/html.html"><span>📐</span>HTML Templates</a>
        
    </li>
    <li>
        
        <a href="utils.html"><span>🛠️</span>Utilities</a>
        
    </li>
    <li>
        
        <a href="templates/template.html"><span>📰</span>Page Templates</a>
        
    </li>
    </ul>
    </li>
    <li>
        <div class="accordion">
        Implementation
        </div>
            
    <ul>
        
    <li>
        
        <a href="index.html"><span>📺</span><span data-toggle="tooltip" data-title="Main program and exports">
            Main Program
        </span></a>
        
    </li>
    <li>
        
        <a href="cli.html"><span>🐚</span><span data-toggle="tooltip" data-title="Scaffolding functionality">
            Command Line Interface
        </span></a>
        
    </li>
    <li>
        
        <a href="weaver.html"><span>🕷️</span><span data-toggle="tooltip" data-title="Common code for documentation generation">
            Weaver
        </span></a>
        
    </li>
    <li>
        
        <a href="md-weaver.html"><span>✍️</span><span data-toggle="tooltip" data-title="Markdown generation code">
            Markdown Weaver
        </span></a>
        
    </li>
    <li>
        
        <a href="html-weaver.html"><span>🔗</span><span data-toggle="tooltip" data-title="HTML generation code">
            HTML Weaver
        </span></a>
        
    </li>
    <li>
        
        <a href="block-list.html"><span>🧱</span><span data-toggle="tooltip" data-title="Data structure for code/markdown fragments">
            Source Blocks
        </span></a>
        
    </li>
    <li>
        <div class="accordion">
        Translators
        </div>
            
    <ul>
        
    <li>
        
        <a href="translators/translators.html"><span>🗣️</span><span data-toggle="tooltip" data-title="Registering and getting translators">
            Translating Input Files
        </span></a>
        
    </li>
    <li>
        
        <a href="translators/base-translator.html"><span>🗣️</span><span data-toggle="tooltip" data-title="Base class and other types related to translators">
            Translator Base Class
        </span></a>
        
    </li>
    <li>
        
        <a href="translators/md-translator.html"><span>🗣️</span><span data-toggle="tooltip" data-title="Translator for markdown files">
            Markdown Translator
        </span></a>
        
    </li>
    <li>
        
        <a href="translators/ts-translator.html"><span>🗣️</span><span data-toggle="tooltip" data-title="Common code for TypeScript translator">
            TypeScript Translator
        </span></a>
        
    </li>
    <li>
        
        <a href="translators/ts-html-translator.html"><span>🗣️</span><span data-toggle="tooltip" data-title="Translating TypeScript to HTML">
            TypeScript Translator for HTML Output
        </span></a>
        
    </li>
    <li>
        
        <a href="translators/jsdoc-translator.html"><span>🗣️</span>Generic JSDoc Translator</a>
        
    </li>
    </ul>
    </li>
    <li>
        
        <a href="logging.html"><span>📒</span><span data-toggle="tooltip" data-title="Outputting errors and progress to console">
            Logging
        </span></a>
        
    </li>
    </ul>
    </li>
    <li>
        
        <a href="../license.html"><span>📜</span><span data-toggle="tooltip" data-title="License and usage information">
            License
        </span></a>
        
    </li>
    </ul>
        </div>
                <div class="toc-button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevrons-right" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M7 7l5 5l-5 5" />
            <path d="M13 7l5 5l-5 5" />
        </svg></div>
            </div>
            
        <div class="contentarea closepopups son-of-obsidian">
            <h1 id="bundling-js-and-css-files">Bundling JS and CSS Files</h1>
<p><a href="https://webpack.js.org/"><img src="../images/webpack.svg" alt="" width="200" height="200"></a>
HTML files need auxiliary JavaScript and style files to function properly.
The template package provides these files but does not deploy them. There
might be dozens of CSS and JS files needed by various elements in a page.
To make the deployment simpler we use <a href="https://webpack.js.org/">Webpack</a> to bundle the files.</p>
<p>Bundling takes a root file, typically a JS or TS file, finds all the
dependencies of the root file no matter how deep they are, and packs them
to output file(s). There will be a bundled JS file for each root file.
If you have CSS or <a href="http://lesscss.org/">Less</a> files in your dependency graph, those will be
combined to a single CSS file.</p>
<p>The goal is to have fewer JS and CSS files to deploy, thus making the
page loading times faster. To learn more about Webpack operation refer to
the excellent documentation on its <a href="https://webpack.js.org/">home page</a>.</p>
<details>
<summary>bundler imports</summary>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">import</span> <span class="punctuation">*</span> <span class="keyword">as</span> <span id="1088" data-toggle="tooltip" data-title="path.PlatformPath">path</span> <span class="keyword">from</span> <span class="string">&#039;path&#039;</span>
<span class="keyword">import</span> <span class="punctuation">*</span> <span class="keyword">as</span> <span id="1118" data-toggle="tooltip" data-title="typeof fs">fs</span> <span class="keyword">from</span> <span class="string">&#039;fs&#039;</span>
<span class="keyword">import</span> <span class="punctuation">*</span> <span class="keyword">as</span> <span id="1144" data-toggle="tooltip" data-title="typeof webpack">webpack</span> <span class="keyword">from</span> <span class="string">&#039;webpack&#039;</span>
<span class="keyword">import</span> <span class="punctuation">*</span> <span class="keyword">as</span> <span id="1180" data-toggle="tooltip" data-title="typeof MiniCssExtractPlugin">MiniCssExtractPlugin</span> <span class="keyword">from</span> <span class="string">&#039;mini-css-extract-plugin&#039;</span>
<span class="keyword">import</span> <span class="punctuation">*</span> <span class="keyword">as</span> <span id="1245" data-toggle="tooltip" data-title="typeof cfg">cfg</span> <span class="keyword">from</span> <span class="string">&#039;./config&#039;</span>
<span class="keyword">import</span> <span class="punctuation">*</span> <span class="keyword">as</span> <span id="1278" data-toggle="tooltip" data-title="typeof log">log</span> <span class="keyword">from</span> <span class="string">&#039;./logging&#039;</span>
<span class="keyword">import</span> <span id="1304" data-toggle="tooltip" data-title="typeof CssMinimizerPlugin">CssMinimizerPlugin</span> <span class="punctuation">=</span> <span class="keyword">require</span><span class="punctuation">(</span><span class="string">&#039;css-minimizer-webpack-plugin&#039;</span><span class="punctuation">)</span>
</code></pre>
</details>
<h2 id="gathering-root-files">Gathering Root Files</h2>
<p>The set of root files for the bundle are maintained in a dictionary in the
<a href="html-weaver.html">HtmlWeaver class</a>. The dictionary is defined here.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">export</span> <span class="keyword">interface</span> <span id="1373" class="typename" data-toggle="tooltip" data-title="CodeFiles">CodeFiles</span> <span class="punctuation">{</span>
    <span class="punctuation">[</span><span id="1620" data-toggle="tooltip" data-title="string">name</span><span class="punctuation">:</span> <span class="keyword">string</span><span class="punctuation">]</span><span class="punctuation">:</span> <span class="keyword">string</span>
<span class="punctuation">}</span>
</code></pre>
<h2 id="webpack-configuration">Webpack Configuration</h2>
<p>The static part of the Webpack configuration is defined in the constant
object below.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">const</span> <span id="1790" data-toggle="tooltip" data-title="&quot;node_modules&quot;">nmdir</span> <span class="punctuation">=</span> <span class="string">&quot;node_modules&quot;</span>

<span class="keyword">const</span> <span id="1822" data-toggle="tooltip" data-title="webpack.Configuration">config</span><span class="punctuation">:</span> <a href="bundler.html#1144"><span data-toggle="tooltip" data-title="any">webpack</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="webpack.Configuration">Configuration</span> <span class="punctuation">=</span> <span class="punctuation">{</span>
    <span id="1856" data-toggle="tooltip" data-title="{ rules: ({ test: RegExp; use: { loader: string; options: { transpileOnly: boolean; }; }[]; } | { test: RegExp; use: string[]; } | { test: RegExp; type: string; })[]; }">module</span><span class="punctuation">:</span> <span class="punctuation">{</span>
</code></pre>
<p>The rules specify how files of different types are loaded. Each file
type uses one or more loaders to transform it from the source format
to Webpack's &quot;native&quot; format Javascript.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>        <span id="1871" data-toggle="tooltip" data-title="({ test: RegExp; use: { loader: string; options: { transpileOnly: boolean; }; }[]; } | { test: RegExp; use: string[]; } | { test: RegExp; type: string; })[]">rules</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="comment">/**
             * For TypeScript files we use the [ts-loader][] to transpile TS 
             * to JS. The loader does not perform type checking; typing 
             * errors are reported by LiTScript when it is compiling the 
             * project.  
             */</span>
            <span class="punctuation">{</span>
                <span id="2435" data-toggle="tooltip" data-title="RegExp">test</span><span class="punctuation">:</span> <span class="string">/\.ts$/</span><span class="punctuation">,</span>
                <span id="2467" data-toggle="tooltip" data-title="{ loader: string; options: { transpileOnly: boolean; }; }[]">use</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span>
                    <span id="2492" data-toggle="tooltip" data-title="string">loader</span><span class="punctuation">:</span> <span class="string">&#039;ts-loader&#039;</span><span class="punctuation">,</span>
                    <span id="2534" data-toggle="tooltip" data-title="{ transpileOnly: boolean; }">options</span><span class="punctuation">:</span> <span class="punctuation">{</span>
                        <span id="2566" data-toggle="tooltip" data-title="boolean">transpileOnly</span><span class="punctuation">:</span> <span class="keyword">true</span>
                    <span class="punctuation">}</span>
                <span class="punctuation">}</span><span class="punctuation">]</span>
            <span class="punctuation">}</span><span class="punctuation">,</span>
            <span class="comment">/**
             * Style files can come in two flavors: Less and basic CSS. 
             * Both of these are handled by a queue of loaders. When using
             * Less, [less-loader][] transforms Less files to CSS before
             * passing it forward. The next one is the standard [css-loader][]
             * which transforms CSS to JS. The last loader is provided by
             * [MiniCssExtractPlugin][]. It extracts CSS into separate files 
             * and creates a separate CSS file for each root file that 
             * imports style files.
             */</span>
            <span class="punctuation">{</span>
                <span id="3287" data-toggle="tooltip" data-title="RegExp">test</span><span class="punctuation">:</span> <span class="string">/\.less$/</span><span class="punctuation">,</span>
                <span id="3321" data-toggle="tooltip" data-title="string[]">use</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                    <a href="bundler.html#1180"><span data-toggle="tooltip" data-title="typeof MiniCssExtractPlugin">MiniCssExtractPlugin</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string">loader</span><span class="punctuation">,</span>
                    <span class="string">&quot;css-loader&quot;</span><span class="punctuation">,</span>
                    <span class="string">&quot;less-loader&quot;</span>
                <span class="punctuation">]</span>
            <span class="punctuation">}</span><span class="punctuation">,</span>
            <span class="punctuation">{</span>
                <span id="3515" data-toggle="tooltip" data-title="RegExp">test</span><span class="punctuation">:</span> <span class="string">/\.css$/</span><span class="punctuation">,</span>
                <span id="3548" data-toggle="tooltip" data-title="string[]">use</span><span class="punctuation">:</span> <span class="punctuation">[</span>
                    <a href="bundler.html#1180"><span data-toggle="tooltip" data-title="typeof MiniCssExtractPlugin">MiniCssExtractPlugin</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string">loader</span><span class="punctuation">,</span>
                    <span class="string">&quot;css-loader&quot;</span>
                <span class="punctuation">]</span>
            <span class="punctuation">}</span><span class="punctuation">,</span>
            <span class="comment">/**
             * Images in SVG, PNG, GIF, and JPG format will be loaded by the 
             * [url-loader][]. It will inline files which are small enough 
             * to further improve loading times.
             */</span>
            <span class="punctuation">{</span>
                <span id="3946" data-toggle="tooltip" data-title="RegExp">test</span><span class="punctuation">:</span> <span class="string">/\.(svg|png|gif|jpg)$/</span><span class="punctuation">,</span>
                <span id="3993" data-toggle="tooltip" data-title="string">type</span><span class="punctuation">:</span> <span class="string">&#039;asset&#039;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">]</span>
    <span class="punctuation">}</span><span class="punctuation">,</span>
</code></pre>
<p>The resolve setting specifies which extensions are appended to import
statements when dependencies are resolved and in which order.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <span id="4058" data-toggle="tooltip" data-title="{ extensions: string[]; }">resolve</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span id="4240" data-toggle="tooltip" data-title="string[]">extensions</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&#039;.ts&#039;</span><span class="punctuation">,</span> <span class="string">&#039;.js&#039;</span><span class="punctuation">,</span> <span class="string">&#039;.less&#039;</span><span class="punctuation">]</span>
    <span class="punctuation">}</span><span class="punctuation">,</span>
</code></pre>
<p>We need to set absolute path for loader modules so Webpack can find
them when running the tool from different project directory. We find
the correct directory using an auxiliary function.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <span id="4293" data-toggle="tooltip" data-title="{ modules: string[]; }">resolveLoader</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span id="4546" data-toggle="tooltip" data-title="string[]">modules</span><span class="punctuation">:</span> <a href="bundler.html#5675"><span class="member" data-toggle="tooltip" data-title="() =&gt; string[]">nodeModulesDirs</span></a><span class="punctuation">(</span><span class="punctuation">)</span>
    <span class="punctuation">}</span><span class="punctuation">,</span>
</code></pre>
<p>The plugins section instantiates plugins used in the bundle. We use only
the <a href="https://github.com/webpack-contrib/mini-css-extract-plugin">MiniCssExtractPlugin</a>. We configure it to write to <code>css/</code>
subfolder under the output directory. The body of the CSS file name will
be the same as for the root file.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <span id="4590" data-toggle="tooltip" data-title="MiniCssExtractPlugin[]">plugins</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="keyword">new</span> <a href="bundler.html#1180"><span data-toggle="tooltip" data-title="typeof MiniCssExtractPlugin">MiniCssExtractPlugin</span></a><span class="punctuation">(</span><span class="punctuation">{</span>
            <span id="4939" data-toggle="tooltip" data-title="string">filename</span><span class="punctuation">:</span> <span class="string">&quot;css/[name].css&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">)</span>
    <span class="punctuation">]</span><span class="punctuation">,</span>
</code></pre>
<p>The output setting specifies where the packed JS file will be saved. We
put them into <code>js/</code> subfolder in the output directory. The name of the
output file is copied from the root file.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <span id="4999" data-toggle="tooltip" data-title="{ filename: string; assetModuleFilename: string; }">output</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span id="5241" data-toggle="tooltip" data-title="string">filename</span><span class="punctuation">:</span> <span class="string">&#039;js/[name].js&#039;</span><span class="punctuation">,</span>
        <span id="5276" data-toggle="tooltip" data-title="string">assetModuleFilename</span><span class="punctuation">:</span> <span class="string">&#039;images/[hash][ext][query]&#039;</span>
    <span class="punctuation">}</span><span class="punctuation">,</span>
</code></pre>
<p>Optimization settings instruct the bundler to minimize generated JS and
CSS. JS minimizer is included with Webpack, but for CSS minimization we
need additional plugin.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <span id="5342" data-toggle="tooltip" data-title="{ minimizer: (&quot;...&quot; | CssMinimizerPlugin&lt;CssMinimizerPlugin.CssNanoOptionsExtended&gt;)[]; }">optimization</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span id="5574" data-toggle="tooltip" data-title="(&quot;...&quot; | CssMinimizerPlugin&lt;CssMinimizerPlugin.CssNanoOptionsExtended&gt;)[]">minimizer</span><span class="punctuation">:</span> <span class="punctuation">[</span>
            <span class="string">&#039;...&#039;</span><span class="punctuation">,</span>
            <span class="keyword">new</span> <a href="bundler.html#1304"><span data-toggle="tooltip" data-title="typeof CssMinimizerPlugin">CssMinimizerPlugin</span></a><span class="punctuation">(</span><span class="punctuation">)</span>
        <span class="punctuation">]</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</code></pre>
<p>Resolving the location of the <code>node_modules</code> directory requires to look into
couple of places. The relative path is different when LiTScript is installed
locally vs. globally.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">function</span> <span id="5675" class="member" data-toggle="tooltip" data-title="() =&gt; string[]">nodeModulesDirs</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">:</span> <span class="keyword">string</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">{</span>
    <span class="keyword">let</span> <span id="5925" data-toggle="tooltip" data-title="string[]">res</span><span class="punctuation">:</span> <span class="keyword">string</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="punctuation">[</span><span class="punctuation">]</span>
    <span class="keyword">let</span> <span id="5953" data-toggle="tooltip" data-title="string">dir</span> <span class="punctuation">=</span> <a href="bundler.html#1088"><span data-toggle="tooltip" data-title="path.PlatformPath">path</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(...paths: string[]) =&gt; string">resolve</span><span class="punctuation">(</span><span data-toggle="tooltip" data-title="string">__dirname</span><span class="punctuation">,</span> <span class="string">&quot;../..&quot;</span><span class="punctuation">,</span> <a href="bundler.html#1790"><span data-toggle="tooltip" data-title="&quot;node_modules&quot;">nmdir</span></a><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#1118"><span data-toggle="tooltip" data-title="typeof fs">fs</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(path: fs.PathLike) =&gt; boolean">existsSync</span><span class="punctuation">(</span><a href="bundler.html#5953"><span data-toggle="tooltip" data-title="string">dir</span></a><span class="punctuation">)</span><span class="punctuation">)</span>
        <a href="bundler.html#5925"><span data-toggle="tooltip" data-title="string[]">res</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(...items: string[]) =&gt; number">push</span><span class="punctuation">(</span><a href="bundler.html#5953"><span data-toggle="tooltip" data-title="string">dir</span></a><span class="punctuation">)</span>
    <a href="bundler.html#5953"><span data-toggle="tooltip" data-title="string">dir</span></a> <span class="punctuation">=</span> <a href="bundler.html#1088"><span data-toggle="tooltip" data-title="path.PlatformPath">path</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(...paths: string[]) =&gt; string">resolve</span><span class="punctuation">(</span><span data-toggle="tooltip" data-title="string">__dirname</span><span class="punctuation">,</span> <span class="string">&quot;../..&quot;</span><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#1088"><span data-toggle="tooltip" data-title="path.PlatformPath">path</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(path: string, suffix?: string) =&gt; string">basename</span><span class="punctuation">(</span><a href="bundler.html#5953"><span data-toggle="tooltip" data-title="string">dir</span></a><span class="punctuation">)</span> <span class="punctuation">==</span> <a href="bundler.html#1790"><span data-toggle="tooltip" data-title="&quot;node_modules&quot;">nmdir</span></a><span class="punctuation">)</span>
        <a href="bundler.html#5925"><span data-toggle="tooltip" data-title="string[]">res</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(...items: string[]) =&gt; number">push</span><span class="punctuation">(</span><a href="bundler.html#5953"><span data-toggle="tooltip" data-title="string">dir</span></a><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#5925"><span data-toggle="tooltip" data-title="string[]">res</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="number">length</span> <span class="punctuation">&gt;</span> <span class="number">0</span><span class="punctuation">)</span>
        <span class="keyword">return</span> <a href="bundler.html#5925"><span data-toggle="tooltip" data-title="string[]">res</span></a>
    <span class="keyword">throw</span> <span class="typename" data-toggle="tooltip" data-title="ErrorConstructor">Error</span><span class="punctuation">(</span><span class="string">`Could not find &quot;${</span><a href="bundler.html#1790"><span data-toggle="tooltip" data-title="&quot;node_modules&quot;">nmdir</span></a><span class="string">}&quot; directory`</span><span class="punctuation">)</span>
<span class="punctuation">}</span>
</code></pre>
<h2 id="initializing-dynamic-configuration">Initializing Dynamic Configuration</h2>
<p>The rest of the Webpack configuration is initialized by the function below.
It gets the list of root files as an argument.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">function</span> <span id="6260" class="member" data-toggle="tooltip" data-title="(codeFiles: CodeFiles) =&gt; void">initConfig</span><span class="punctuation">(</span><span id="6813" data-toggle="tooltip" data-title="CodeFiles">codeFiles</span><span class="punctuation">:</span> <a href="bundler.html#1373"><span class="typename" data-toggle="tooltip" data-title="CodeFiles">CodeFiles</span></a><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">let</span> <span id="6845" data-toggle="tooltip" data-title="cfg.Options">opts</span> <span class="punctuation">=</span> <a href="bundler.html#1245"><span data-toggle="tooltip" data-title="typeof cfg">cfg</span></a><span class="punctuation">.</span><a href="config.html#7232"><span class="member" data-toggle="tooltip" data-title="() =&gt; cfg.Options">getOptions</span></a><span class="punctuation">(</span><span class="punctuation">)</span>
</code></pre>
<p>Running LiTScript in development mode, will produce source maps for JS
files to aid debugging. In production mode the outputted JS files are
minified and debugging info is omitted.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="&quot;none&quot; | &quot;development&quot; | &quot;production&quot;">mode</span> <span class="punctuation">=</span> <a href="bundler.html#6845"><span data-toggle="tooltip" data-title="cfg.Options">opts</span></a><span class="punctuation">.</span><a href="config.html#5777"><span data-toggle="tooltip" data-title="&quot;dev&quot; | &quot;prod&quot;">deployMode</span></a> <span class="punctuation">==</span> <span class="string">&#039;dev&#039;</span> <span class="punctuation">?</span>
        <span class="string">&#039;development&#039;</span> <span class="punctuation">:</span> <span class="string">&#039;production&#039;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#6845"><span data-toggle="tooltip" data-title="cfg.Options">opts</span></a><span class="punctuation">.</span><a href="config.html#5777"><span data-toggle="tooltip" data-title="&quot;dev&quot; | &quot;prod&quot;">deployMode</span></a> <span class="punctuation">==</span> <span class="string">&#039;dev&#039;</span><span class="punctuation">)</span>
        <a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string | false">devtool</span> <span class="punctuation">=</span> <span class="string">&#039;inline-source-map&#039;</span>
</code></pre>
<p>The context setting contains the absolute path of the project base
directory.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string">context</span> <span class="punctuation">=</span> <a href="bundler.html#1088"><span data-toggle="tooltip" data-title="path.PlatformPath">path</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(...paths: string[]) =&gt; string">resolve</span><span class="punctuation">(</span><a href="bundler.html#6845"><span data-toggle="tooltip" data-title="cfg.Options">opts</span></a><span class="punctuation">.</span><a href="config.html#1685"><span data-toggle="tooltip" data-title="string">baseDir</span></a><span class="punctuation">)</span>
</code></pre>
<p>We get the root code files as an argument, but the main JS file comes
from the template. This contains all the JavaScript code needed by the
template. The other ones are brought in by the user. They contain
<a href="visualizer.html">visualizers</a> and their dependencies.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string | string[] | (() =&gt; string | string[] | webpack.EntryObject | Promise&lt;EntryStatic&gt;) | webpack.EntryObject">entry</span> <span class="punctuation">=</span> <a href="bundler.html#6813"><span data-toggle="tooltip" data-title="CodeFiles">codeFiles</span></a>
</code></pre>
<p>Last, we set the output directory, which comes staight from the
LiTScript options.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code>    <a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="Output">output</span><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string">path</span> <span class="punctuation">=</span> <a href="bundler.html#1088"><span data-toggle="tooltip" data-title="path.PlatformPath">path</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(path: string) =&gt; boolean">isAbsolute</span><span class="punctuation">(</span><a href="bundler.html#6845"><span data-toggle="tooltip" data-title="cfg.Options">opts</span></a><span class="punctuation">.</span><a href="config.html#1905"><span data-toggle="tooltip" data-title="string">outDir</span></a><span class="punctuation">)</span> <span class="punctuation">?</span>
        <a href="bundler.html#6845"><span data-toggle="tooltip" data-title="cfg.Options">opts</span></a><span class="punctuation">.</span><a href="config.html#1905"><span data-toggle="tooltip" data-title="string">outDir</span></a> <span class="punctuation">:</span>
        <a href="bundler.html#1088"><span data-toggle="tooltip" data-title="path.PlatformPath">path</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(...paths: string[]) =&gt; string">resolve</span><span class="punctuation">(</span><a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="string">context</span><span class="punctuation">,</span> <a href="bundler.html#6845"><span data-toggle="tooltip" data-title="cfg.Options">opts</span></a><span class="punctuation">.</span><a href="config.html#1905"><span data-toggle="tooltip" data-title="string">outDir</span></a><span class="punctuation">)</span>
<span class="punctuation">}</span>
</code></pre>
<h2 id="bundling-files">Bundling Files</h2>
<p>Webpack runs asynchronously, it returns before it has done the bunding. We
provide a callback function which Webpack calls when it has completed. The
callback will set the <code>done</code> flag, so we can wait for the completion.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">var</span> <span id="8289" data-toggle="tooltip" data-title="boolean">done</span> <span class="punctuation">=</span> <span class="keyword">false</span>
</code></pre>
<p>The bundling function is straightforward. We initialize the configuration
and create the Webpack compiler passing it the configuration. Depending on
whether we are in watch mode we call eiher <code>watch</code> or <code>run</code>. The former runs
forever in the background monitoring the input files. It reruns automatically
whenever any file in the dependency graph changes. The latter runs only one
time.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">export</span> <span class="keyword">function</span> <span id="8302" class="member" data-toggle="tooltip" data-title="(codeFiles: CodeFiles) =&gt; void">bundle</span><span class="punctuation">(</span><span id="8753" data-toggle="tooltip" data-title="CodeFiles">codeFiles</span><span class="punctuation">:</span> <a href="bundler.html#1373"><span class="typename" data-toggle="tooltip" data-title="CodeFiles">CodeFiles</span></a><span class="punctuation">)</span> <span class="punctuation">{</span>
    <a href="bundler.html#8289"><span data-toggle="tooltip" data-title="boolean">done</span></a> <span class="punctuation">=</span> <span class="keyword">false</span>
    <a href="bundler.html#1278"><span data-toggle="tooltip" data-title="typeof log">log</span></a><span class="punctuation">.</span><a href="logging.html#4588"><span class="member" data-toggle="tooltip" data-title="(output: string) =&gt; void">info</span></a><span class="punctuation">(</span><a href="bundler.html#1278"><span data-toggle="tooltip" data-title="typeof log">log</span></a><span class="punctuation">.</span><a href="logging.html#351"><span class="typename" data-toggle="tooltip" data-title="typeof log.Colors">Colors</span></a><span class="punctuation">.</span><a href="logging.html#705"><span data-toggle="tooltip" data-title="log.Colors.Cyan">Cyan</span></a> <span class="punctuation">+</span> <span class="string">&quot;Bundling...&quot;</span><span class="punctuation">)</span>
    <a href="bundler.html#6260"><span class="member" data-toggle="tooltip" data-title="(codeFiles: CodeFiles) =&gt; void">initConfig</span></a><span class="punctuation">(</span><a href="bundler.html#8753"><span data-toggle="tooltip" data-title="CodeFiles">codeFiles</span></a><span class="punctuation">)</span>
    <span class="keyword">let</span> <span id="8877" data-toggle="tooltip" data-title="webpack.Compiler">compiler</span> <span class="punctuation">=</span> <a href="bundler.html#1144"><span data-toggle="tooltip" data-title="typeof webpack">webpack</span></a><span class="punctuation">(</span><a href="bundler.html#1822"><span data-toggle="tooltip" data-title="webpack.Configuration">config</span></a><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#1245"><span data-toggle="tooltip" data-title="typeof cfg">cfg</span></a><span class="punctuation">.</span><a href="config.html#7232"><span class="member" data-toggle="tooltip" data-title="() =&gt; cfg.Options">getOptions</span></a><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">.</span><a href="config.html#5575"><span data-toggle="tooltip" data-title="boolean">watch</span></a><span class="punctuation">)</span>
        <a href="bundler.html#8877"><span data-toggle="tooltip" data-title="webpack.Compiler">compiler</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(watchOptions: WatchOptions, handler: CallbackFunction&lt;webpack.Stats&gt;) =&gt; webpack.Watching">watch</span><span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span> <a href="bundler.html#9018"><span class="member" data-toggle="tooltip" data-title="(err: Error, stats: webpack.Stats) =&gt; void">handler</span></a><span class="punctuation">)</span>
    <span class="keyword">else</span>
        <a href="bundler.html#8877"><span data-toggle="tooltip" data-title="webpack.Compiler">compiler</span></a><span class="punctuation">.</span><span class="member" data-toggle="tooltip" data-title="(callback: CallbackFunction&lt;webpack.Stats&gt;) =&gt; void">run</span><span class="punctuation">(</span><a href="bundler.html#9018"><span class="member" data-toggle="tooltip" data-title="(err: Error, stats: webpack.Stats) =&gt; void">handler</span></a><span class="punctuation">)</span>
<span class="punctuation">}</span>
</code></pre>
<p>Both <code>run</code> and <code>watch</code> methods take the handler callback which will be
called when an error occurs or when the bundling is finished. We log
the error/status information to console, and set the <code>done</code> flag when
bundle is ready.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">function</span> <span id="9018" class="member" data-toggle="tooltip" data-title="(err: Error, stats: webpack.Stats) =&gt; void">handler</span><span class="punctuation">(</span><span id="9291" data-toggle="tooltip" data-title="Error">err</span><span class="punctuation">:</span> <span class="typename" data-toggle="tooltip" data-title="Error">Error</span><span class="punctuation">,</span> <span id="9302" data-toggle="tooltip" data-title="webpack.Stats">stats</span><span class="punctuation">:</span> <a href="bundler.html#1144"><span data-toggle="tooltip" data-title="any">webpack</span></a><span class="punctuation">.</span><span data-toggle="tooltip" data-title="webpack.Stats">Stats</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#9291"><span data-toggle="tooltip" data-title="Error">err</span></a><span class="punctuation">)</span>
        <a href="bundler.html#1278"><span data-toggle="tooltip" data-title="typeof log">log</span></a><span class="punctuation">.</span><a href="logging.html#4193"><span class="member" data-toggle="tooltip" data-title="(err: Error) =&gt; void">error</span></a><span class="punctuation">(</span><a href="bundler.html#9291"><span data-toggle="tooltip" data-title="Error">err</span></a><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><a href="bundler.html#9302"><span data-toggle="tooltip" data-title="webpack.Stats">stats</span></a><span class="punctuation">)</span> <span class="punctuation">{</span>
        <a href="bundler.html#1278"><span data-toggle="tooltip" data-title="typeof log">log</span></a><span class="punctuation">.</span><a href="logging.html#3008"><span class="member" data-toggle="tooltip" data-title="(stats: webpack.Stats) =&gt; void">reportBundleStats</span></a><span class="punctuation">(</span><a href="bundler.html#9302"><span data-toggle="tooltip" data-title="webpack.Stats">stats</span></a><span class="punctuation">)</span>
        <a href="bundler.html#8289"><span data-toggle="tooltip" data-title="boolean">done</span></a> <span class="punctuation">=</span> <span class="keyword">true</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</code></pre>
<p>To be able to wait the bundle completion, we export a function that polls
the <code>done</code> flag once per second.</p>
<pre class="syntaxhighlight narrow-scrollbars"><code><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span id="9451" class="member" data-toggle="tooltip" data-title="() =&gt; Promise&lt;void&gt;">finished</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">while</span> <span class="punctuation">(</span><span class="punctuation">!</span><a href="bundler.html#8289"><span data-toggle="tooltip" data-title="boolean">done</span></a><span class="punctuation">)</span>
        <span class="keyword">await</span> <span class="keyword">new</span> <span class="typename" data-toggle="tooltip" data-title="PromiseConstructor">Promise</span><span class="punctuation">(</span><span id="9661" data-toggle="tooltip" data-title="(value: unknown) =&gt; void">resolve</span> <span class="punctuation">=&gt;</span> <span class="member" data-toggle="tooltip" data-title="typeof setTimeout">setTimeout</span><span class="punctuation">(</span><a href="bundler.html#9661"><span data-toggle="tooltip" data-title="(value: unknown) =&gt; void">resolve</span></a><span class="punctuation">,</span> <span class="number">1000</span><span class="punctuation">)</span><span class="punctuation">)</span>
<span class="punctuation">}</span>
</code></pre>

        </div>
            <div class="sidepane narrow-scrollbars">
                
        <div class="pagemenu">
            <h3>On This Page</h3>
                <ul class="pagetree">
                </ul>
        </div>
            </div>
        </div>
        
        <div class="footer">
            <a class="footer-button" href="dependency-graph.html">
            <p>Previous</p>
            <p>« Dependency Graph</p>
        </a>
            <div class="footer-text">
                <p>Copyright © 2023 Tommi Johtela</p>
                <p>Generated by 
                    <a href="https://johtela.github.io/litscript">LiTScript</a>
                </p>
            </div>
            <a class="footer-button" href="templates/html.html">
            <p>Next</p>
            <p>HTML Templates »</p>
        </a>
        </div>
    
        <script src="../js/normal.js"></script>
    </body>
    </html>